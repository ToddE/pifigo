#!/bin/bash
# Always exit on error
set -e

# --- Configuration ---
ARMBIAN_WILDCARD_FILE="/etc/netplan/10-dhcp-all-interfaces.yaml"
NEW_ETH_CONFIG_FILE="/etc/netplan/50-pifigo-ethernet.yaml"

echo "Running pre-installation script for pifigo..."

# --- Main Logic ---
# Check if the problematic Armbian wildcard file exists.
if [ -f "$ARMBIAN_WILDCARD_FILE" ]; then
    echo "Found default Armbian wildcard netplan configuration."
    echo "This can conflict with pifigo. Attempting to create a specific configuration."

    # 1. Find the primary Ethernet interface.
    # We look for the interface that has a carrier (is plugged in) and starts with 'e'.
    # This is a reliable way to find the active LAN port.
    PRIMARY_ETH_INTERFACE=$(ip -o link show | awk -F': ' '/state UP/ && /eth|end|enp/ {print $2}')

    if [ -z "$PRIMARY_ETH_INTERFACE" ]; then
        echo "Warning: Could not determine the primary Ethernet interface. Skipping automatic reconfiguration."
        # Exit gracefully. The user might have a custom setup.
        exit 0
    fi

    echo "Detected primary Ethernet interface: $PRIMARY_ETH_INTERFACE"

    # 2. Create the new, specific configuration file.
    echo "Creating new specific configuration at $NEW_ETH_CONFIG_FILE..."
    cat << EOF > "$NEW_ETH_CONFIG_FILE"
# This file was generated by the pifigo installer to create a stable
# network configuration that does not conflict with the Wi-Fi hotspot.
network:
  version: 2
  renderer: networkd
  ethernets:
    $PRIMARY_ETH_INTERFACE:
      dhcp4: true
EOF

    # 3. Rename the old wildcard file as a backup instead of deleting.
    echo "Backing up conflicting wildcard file to $ARMBIAN_WILDCARD_FILE.bak"
    mv "$ARMBIAN_WILDCARD_FILE" "$ARMBIAN_WILDCARD_FILE.bak"

    echo "Successfully replaced wildcard netplan config with a specific one."
    # We don't run 'netplan apply' here, as the system will do that
    # after the full package installation is complete.
else
    echo "No default Armbian wildcard configuration found. Proceeding with installation."
fi

exit 0
